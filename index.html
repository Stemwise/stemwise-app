<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stemwise – Count • Cost • Price</title>
  <meta name="theme-color" content="#0B5D3E" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./assets/icon-192.png" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="stylesheet" href="./styles.css" />
</head>


<body>
  <header class="topbar">
    <h1>Stemwise</h1>
    <div class="tagline">Count • Cost • Price</div>
    <button id="installBtn" class="btn secondary" hidden>Install</button>
  </header>

  <main class="container">
    <section class="card">
      <h2>Business Settings</h2>
      <div class="grid">
        <label>VAT registration date
          <input type="date" id="vatRegisteredFrom" />
        </label>
        <label>VAT rate (%)
          <input type="number" id="vatRate" step="1" />
        </label>
        <label>Labour rate (£/hour)
          <input type="number" id="laborRate" step="0.01" />
        </label>
        <label>Invoice-level fees to spread (£)
          <input type="number" id="globalFees" step="0.01" />
        </label>
        <label>Fee share mode
          <select id="feeShareMode">
            <option value="byValue">Proportional by value</option>
            <option value="none">Do not spread</option>
          </select>
        </label>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <h2>Cost Database</h2>
        <div class="row-actions">
          <button id="addRow" class="btn">Add</button>
          <label class="btn secondary file-label">
            <input type="file" id="importCSV" accept=".csv" />
            Import CSV
          </label>
          <button id="exportCSV" class="btn secondary">Export CSV</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="costTable">
          <thead>
            <tr>
              <th>Variety</th>
              <th>Grade</th>
              <th>Supplier</th>
              <th>Pack size</th>
              <th>Stems/pack</th>
              <th>Pack price (£)</th>
              <th>Invoice date</th>
              <th>Cost/stem ex-VAT*</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted">
        * If the invoice date is before your VAT registration date, pack prices are treated as including value-added tax and converted to excluding value-added tax. 
        Invoice-level fees (if any) are proportionally applied by value.
      </p>
    </section>

    <section class="card">
      <div class="row">
        <h2>Photo Assist (Beta)</h2>
      </div>
      <p class="muted">Load an arrangement photo. Pick a flower from your database, then tap/click each stem in the photo to count it. Counts sync to the Arrangement list below. (Automatic detection can be added later.)</p>
      <div class="photo-assist">
        <div class="photo-controls">
          <label class="btn secondary file-label">
            <input type="file" id="photoInput" accept="image/*" />
            Load photo
          </label>
          <select id="photoVarietySelect"><option value="">Select flower...</option></select>
          <button id="clearMarkers" class="btn secondary" disabled>Clear markers</button>
        </div>
        <div class="canvas-wrap">
          <canvas id="photoCanvas"></canvas>
        </div>
        <div class="muted" id="photoHelp">Tip: zoom with pinch (mobile) or Ctrl+scroll (desktop) then click to add a marker.</div>
      </div>
    </section>

    <section class="card">
      <h2>Arrangement Cost & Price</h2>
      <div id="arrangementList"></div>
      <div class="row">
        <button id="addItem" class="btn">Add flower</button>
      </div>

      <div class="grid">
        <label>Sundries ex-VAT (£)
          <input type="number" id="sundries" step="0.01" />
        </label>
        <label>Wastage (%)
          <input type="number" id="wastagePct" step="1" />
        </label>
        <label>Labour (minutes)
          <input type="number" id="laborMinutes" step="1" />
        </label>
        <label>Target margin (%)
          <input type="number" id="targetMarginPct" step="1" />
        </label>
      </div>

      <div class="grid two">
        <div class="subcard">
          <h3>Breakdown (ex-VAT)</h3>
          <div id="breakdownList" class="kv"></div>
        </div>
        <div class="subcard">
          <h3>Suggested Retail</h3>
          <div class="kv">
            <div><span>Margin</span><strong id="margin">£0.00</strong></div>
            <div><span>Retail ex-VAT</span><strong id="retailEx">£0.00</strong></div>
            <div><span>Retail inc-VAT</span><strong id="retailInc">£0.00</strong></div>
          </div>
        </div>
      </div>

      <p class="muted">Pricing logic: cost per stem is calculated excluding value-added tax, converting pre-registration invoice prices to ex-VAT. Invoice-level fees can be shared by value. Suggested retail adds target margin, then value-added tax.</p>
    </section>
  </main>

  <footer class="footer">
    <span>Offline-ready • Your data stays in your browser (local storage)</span>
  </footer>

<!-- Load the fixed app bundle (cache-busted) -->
<script type="module" src="./app.v2.js?v=force13"></script>

<!-- (Optional) keep SW, but only after app loads -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
</script>
  <!-- EMERGENCY CSV PROBE: paste this just before </body> -->
<script>
(function(){
  // Status box
  function ensureStatus(){
    let box = document.getElementById('csvStatusBox');
    if (!box){
      box = document.createElement('div');
      box.id = 'csvStatusBox';
      box.style.cssText = 'position:fixed;right:12px;bottom:12px;max-width:420px;background:#0f172a;color:#e5e7eb;border-radius:10px;padding:10px 12px;font:12px/1.4 system-ui,Segoe UI,Roboto,Arial;z-index:99999;box-shadow:0 8px 24px rgba(0,0,0,.24)';
      box.innerHTML = '<div style="font-weight:600;margin-bottom:6px">CSV Diagnostics</div><div id="csvStatus" style="white-space:pre-wrap;max-height:220px;overflow:auto">Ready…</div>';
      document.body.appendChild(box);
    }
    return document.getElementById('csvStatus');
  }
  const logEl = ensureStatus();
  function log(m){ logEl.textContent += "\n" + m; logEl.scrollTop = logEl.scrollHeight; }

  // Ensure there is a file input with the correct ID
  let input = document.getElementById('importCSV');
  if (!input) {
    input = document.createElement('input');
    input.type = 'file';
    input.id = 'importCSV';
    input.accept = '.csv';
    input.style = 'position:fixed;left:12px;bottom:12px;z-index:99999';
    document.body.appendChild(input);
    log('No #importCSV found — created a temporary one (bottom-left).');
  } else {
    log('#importCSV found.');
  }

  function detectDelimiter(sample){
    const candidates=[",",";","\\t","|"];
    let best=",", bestScore=-1;
    const lines = sample.split(/\\r?\\n/).filter(Boolean).slice(0,10);
    for (const d of candidates){
      const counts = lines.map(l => (l.match(new RegExp(d==="\\t"?"\\t":d, "g"))||[]).length);
      const mean = counts.reduce((a,b)=>a+b,0)/(counts.length||1);
      const varc = counts.reduce((a,b)=>a + Math.pow(b-mean,2),0)/(counts.length||1);
      const score = mean - 0.5*varc;
      if (score>bestScore){ bestScore=score; best=d; }
    }
    return best;
  }
  function splitLine(line, delim){
    const out=[]; let cur=""; let q=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch === '"'){ if (q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } continue; }
      if (ch === delim && !q){ out.push(cur); cur=""; } else { cur+=ch; }
    }
    out.push(cur); return out.map(s=>s.trim());
  }
function parseCSV(text){
  // 1) Normalise newlines (handles \r\n, \n, and old Mac \r)
  let raw = String(text || "");
  raw = raw.replace(/\r\n/g, "\n").replace(/\r/g, "\n");

  // 2) Strip BOM and trim
  if (raw.charCodeAt(0) === 0xFEFF) raw = raw.slice(1);
  raw = raw.trim();

  if (!raw) return { header: [], rows: [], delim: ',' };

  // 3) Take a small sample for delimiter detection
  const sample = raw.split("\n").slice(0, 20).join("\n");
  const candidates = [',',';','\t','|'];
  let best = ',', bestScore = -1;

  const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const linesForDetect = sample.split("\n").filter(Boolean).slice(0, 10);
  for (const d of candidates){
    const counts = linesForDetect.map(l => (l.match(new RegExp(esc(d), 'g')) || []).length);
    const mean = counts.reduce((a,b)=>a+b,0)/(counts.length||1);
    const variance = counts.reduce((a,b)=>a + Math.pow(b-mean,2),0)/(counts.length||1);
    const score = mean - 0.5*variance;
    if (score > bestScore){ bestScore = score; best = d; }
  }
  const delim = best;

  // 4) CSV-safe split for one line
  function splitLine(line, d){
    const out=[]; let cur=""; let q=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch === '"'){ if (q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } continue; }
      if (ch === d && !q){ out.push(cur); cur=""; } else { cur+=ch; }
    }
    out.push(cur);
    return out.map(s => s.trim());
  }

  // 5) Build rows
  const lines = raw.split("\n").filter(l => l.trim().length);
  if (!lines.length) return { header: [], rows: [], delim };

  let header = splitLine(lines[0], delim).map(h => h.toLowerCase()
    .replace(/[\s_-]+/g,'').replace(/[^\w]/g,''));

  let body = lines.slice(1).map(l => splitLine(l, delim)).filter(r => r.some(c => c.length));

  // 6) Fallbacks:
  //   a) If header collapsed to a single token like "www", try the next non-empty line as header.
  if (header.length < 2 && body.length){
    header = body[0].map(h => String(h).toLowerCase()
      .replace(/[\s_-]+/g,'').replace(/[^\w]/g,''));
    body = body.slice(1);
  }
  //   b) If still no body but there are many delimiters overall, treat all lines after header as rows
  if (!body.length && lines.length > 1){
    body = lines.slice(1).map(l => splitLine(l, delim)).filter(r => r.some(c => c.length));
  }

  return { header, rows: body, delim };
}

  function idx(header, aliases){
    aliases = Array.isArray(aliases)?aliases:[aliases];
    for (const a of aliases){
      const n=a.toLowerCase().replace(/[\\s_-]+/g,"").replace(/[^\\w]/g,"");
      const i=header.indexOf(n); if(i!==-1) return i;
    }
    return -1;
  }

  function handleFile(f){
    const reader = new FileReader();
    reader.onload = () => {
      const text = String(reader.result||"");
      log("Read " + text.length + " chars from " + f.name);
      const parsed = parseCSV(text);
      log("Detected delimiter: " + (parsed.delim==="\\t"?"TAB":parsed.delim));
      log("Header: " + JSON.stringify(parsed.header));
      const map = {
        variety: idx(parsed.header, ["variety","flower","name","description","product","item"]),
        grade: idx(parsed.header, ["grade","length","size","lengthcm","cm","len"]),
        stemsPerPack: idx(parsed.header, ["stemsperpack","stems_per_pack","stemsperbunch","stems","qty","quantity"]),
        packPrice: idx(parsed.header, ["packprice","pack_price","bunchprice","unitprice","price"]),
        invoiceDate: idx(parsed.header, ["invoicedate","invoice_date","date","deliverydate","docdate","deldate"])
      };
      log("Mapped indexes: " + JSON.stringify(map));
      if (parsed.rows.length){
        log("First row raw: " + JSON.stringify(parsed.rows[0]));
      } else {
        log("No data rows detected.");
      }
      alert("CSV read OK. Check the black 'CSV Diagnostics' panel (bottom-right) for details.");
    };
    reader.onerror = () => { log("FileReader error: " + reader.error); alert("Read error: " + reader.error); };
    reader.readAsText(f);
  }

  input.addEventListener('change', e => {
    const f = e.target.files && e.target.files[0];
    if (f) handleFile(f); else log("No file picked.");
  });

  // Also allow drag & drop anywhere
  document.addEventListener("dragover", e => e.preventDefault());
  document.addEventListener("drop", e => { e.preventDefault(); const f=e.dataTransfer?.files?.[0]; if(f){ handleFile(f); } });

  log('CSV probe loaded. Use the file picker (bottom-left) or drag a CSV onto the page.');
})();
</script>
<!-- /EMERGENCY CSV PROBE -->
</body>
</html>
