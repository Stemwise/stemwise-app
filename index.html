<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stemwise – Count • Cost • Price</title>
<meta name="theme-color" content="#0B5D3E" />
<link rel="stylesheet" href="./styles.css" />
<style>
  /* Minimal safety styles if styles.css is missing */
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f8fafc;color:#0f172a}
  .topbar{display:flex;align-items:center;gap:.5rem;padding:12px 16px;background:#0B5D3E;color:#fff}
  .tagline{opacity:.9}
  .container{max-width:1100px;margin:20px auto;padding:0 16px}
  .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .row-actions{display:flex;gap:8px;align-items:center}
  .btn{background:#0B5D3E;color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.secondary{background:#0f172a}
  .btn.danger{background:#b91c1c}
  .file-label{display:inline-flex;align-items:center;gap:8px}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{border-bottom:1px solid #e5e7eb;padding:8px;vertical-align:middle}
  input,select{width:100%;box-sizing:border-box;padding:6px;border:1px solid #cbd5e1;border-radius:8px}
  .muted{color:#64748b;font-size:.9rem}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:12px}
  .grid.two{grid-template-columns:1fr 1fr}
  .subcard{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .kv>div{display:flex;justify-content:space-between;margin:4px 0}
  .item-row{display:grid;grid-template-columns:1fr 120px 140px 40px;gap:8px;align-items:center;margin:6px 0}
  .readonly{padding:8px;border:1px dashed #cbd5e1;border-radius:8px;background:#fff}
  .footer{padding:12px 16px;color:#334155}
  .canvas-wrap{border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
</style>
</head>
<body>
  <header class="topbar">
    <h1>Stemwise</h1>
    <div class="tagline">Count • Cost • Price</div>
    <button id="installBtn" class="btn secondary" hidden>Install</button>
  </header>

  <main class="container">
    <section class="card">
      <h2>Business Settings</h2>
      <div class="grid">
        <label>VAT registration date
          <input type="date" id="vatRegisteredFrom" />
        </label>
        <label>VAT rate (%)
          <input type="number" id="vatRate" step="1" />
        </label>
        <label>Labour rate (£/hour)
          <input type="number" id="laborRate" step="0.01" />
        </label>
        <label>Invoice-level fees to spread (£)
          <input type="number" id="globalFees" step="0.01" />
        </label>
        <label>Fee share mode
          <select id="feeShareMode">
            <option value="byValue">Proportional by value</option>
            <option value="none">Do not spread</option>
          </select>
        </label>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <h2>Cost Database</h2>
        <div class="row-actions">
          <button id="addRow" class="btn">Add</button>
          <label class="btn secondary file-label">
            <input type="file" id="importCSV" accept=".csv" />
            Import CSV
          </label>
          <button id="pasteCSV" class="btn secondary">Paste CSV</button>
          <button id="exportCSV" class="btn secondary">Export CSV</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="costTable">
          <thead>
            <tr>
              <th>Variety</th>
              <th>Grade</th>
              <th>Supplier</th>
              <th>Pack size</th>
              <th>Stems/pack</th>
              <th>Pack price (£)</th>
             <th>Date received</th>
              <th>Cost/stem ex-VAT*</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted">
        * If the invoice date is before your VAT registration date, pack prices are treated as including VAT and converted to ex-VAT. 
        Invoice-level fees (if any) are proportionally applied by value.
      </p>
    </section>

    <section class="card">
      <div class="row">
        <h2>Photo Assist (Beta)</h2>
      </div>
      <p class="muted">Load an arrangement photo. Pick a flower, then click each stem in the photo to count it. Counts sync to the Arrangement list.</p>
      <div class="photo-assist">
        <div class="photo-controls">
          <label class="btn secondary file-label">
            <input type="file" id="photoInput" accept="image/*" />
            Load photo
          </label>
          <select id="photoVarietySelect"><option value="">Select flower...</option></select>
          <button id="clearMarkers" class="btn secondary" disabled>Clear markers</button>
        </div>
        <div class="canvas-wrap">
          <canvas id="photoCanvas"></canvas>
        </div>
        <div class="muted" id="photoHelp">Tip: Ctrl+scroll to zoom (desktop).</div>
      </div>
    </section>

    <section class="card">
      <h2>Arrangement Cost & Price</h2>
      <div id="arrangementList"></div>
      <div class="row">
        <button id="addItem" class="btn">Add flower</button>
      </div>

      <div class="grid">
        <label>Sundries ex-VAT (£)
          <input type="number" id="sundries" step="0.01" />
        </label>
        <label>Wastage (%)
          <input type="number" id="wastagePct" step="1" />
        </label>
        <label>Labour (minutes)
          <input type="number" id="laborMinutes" step="1" />
        </label>
        <label>Target margin (%)
          <input type="number" id="targetMarginPct" step="1" />
        </label>
      </div>

      <div class="grid two">
        <div class="subcard">
          <h3>Breakdown (ex-VAT)</h3>
          <div id="breakdownList" class="kv"></div>
        </div>
        <div class="subcard">
          <h3>Suggested Retail</h3>
          <div class="kv">
            <div><span>Margin</span><strong id="margin">£0.00</strong></div>
            <div><span>Retail ex-VAT</span><strong id="retailEx">£0.00</strong></div>
            <div><span>Retail inc-VAT</span><strong id="retailInc">£0.00</strong></div>
          </div>
        </div>
      </div>

      <p class="muted">Pricing: per-stem cost is ex-VAT (pre-registration prices converted). Invoice fees can be spread by value. Suggested retail adds target margin then VAT.</p>
    </section>
  </main>

  <footer class="footer">
    <span>Offline-ready • Data stays in your browser (local storage)</span>
  </footer>

  <!-- CSV Diagnostics panel is created by script -->
  <script>
  // -------------------- Diagnostics box --------------------
  (function ensureStatusBox(){
    const box = document.createElement('div');
    box.id = 'csvStatusBox';
    box.style.cssText = 'position:fixed;right:12px;bottom:12px;max-width:420px;background:#0f172a;color:#e5e7eb;border-radius:10px;padding:10px 12px;font:12px/1.4 system-ui,Segoe UI,Roboto,Arial;z-index:99999;box-shadow:0 8px 24px rgba(0,0,0,.24)';
    box.innerHTML = '<div style="font-weight:600;margin-bottom:6px">CSV Diagnostics</div><div id="csvStatus" style="white-space:pre-wrap;max-height:220px;overflow:auto">Ready…</div>';
    document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(box));
  })();
  function logStatus(m){ const el=document.getElementById('csvStatus'); if(!el) return; el.textContent += '\\n' + m; el.scrollTop = el.scrollHeight; }
  </script>

  <!-- The entire app (no modules, no external imports) -->
  <script>
  // -------------------- State & utils --------------------
  const LS_KEY='stemwise-app-v1';
  const state = {
    rows: [],
    vatRegisteredFrom: '2025-10-01',
    vatRate: 20,
    laborRate: 18,
    feeShareMode: 'byValue',
    globalFees: 0,
    arrangement: [],
    sundries: 0,
    wastagePct: 0,
    laborMinutes: 0,
    targetMarginPct: 60,
    photo: null,
    photoMarkers: []
  };
  const uid = ()=>Math.random().toString(36).slice(2,10);
  const money = n => isFinite(n) ? new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP',maximumFractionDigits:2}).format(n) : '£0.00';

  function save(){
    try{ const toStore = {...state, photo:null}; localStorage.setItem(LS_KEY, JSON.stringify(toStore)); }catch(e){}
  }
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        Object.assign(state, JSON.parse(raw));
        state.photo = null; // never revive images
      }else{
        // seed demo rows so UI proves it renders
        const r1 = { id: uid(), variety:'Rose Freedom', grade:'60cm', supplier:'DutchXpress', packSize:'20 stems', stemsPerPack:20, packPrice:15.6, invoiceDate:'2025-09-20', notes:'' };
        const r2 = { id: uid(), variety:'Lisianthus White', grade:'XL', supplier:'Aalsmeer', packSize:'10 stems', stemsPerPack:10, packPrice:5.2, invoiceDate:'2025-09-22', notes:'' };
        state.rows=[r1,r2];
        state.arrangement=[{rowId:r1.id, qty:12}];
        state.sundries=1.1; state.wastagePct=3; state.laborMinutes=20;
        save();
      }
    }catch(e){ console.warn(e); }
  }
  load();

  // -------------------- CSV helpers --------------------
  const norm = s => String(s||'').toLowerCase().replace(/[\s_-]+/g,'').replace(/[^\w]/g,'');
  function detectDelim(sample){
    const c=[',',';','\t','|']; let best=',',score=-1;
    const lines=sample.split(/\r?\n/).filter(Boolean).slice(0,10);
    for(const d of c){
      const k=lines.map(l=>(l.match(new RegExp(d==='\\t'?'\\t':d,'g'))||[]).length);
      const m=k.reduce((a,b)=>a+b,0)/(k.length||1);
      const v=k.reduce((a,b)=>a+Math.pow(b-m,2),0)/(k.length||1);
      const s=m-0.5*v; if(s>score){score=s;best=d;}
    } return best;
  }
  function splitLine(line,d){
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){cur+='"';i++;} else {q=!q;} continue; }
      if(ch===d && !q){ out.push(cur); cur=''; } else cur+=ch;
    } out.push(cur); return out.map(s=>s.trim());
  }
  function parseCSV(text){
    const lines=String(text||'').split(/\r?\n/);
    if(!lines.length) return {header:[],rows:[],delim:','};
    const delim=detectDelim(lines.slice(0,10).join('\n'));
    const header=splitLine(lines.shift(),delim).map(norm);
    const rows=[]; for(const line of lines){ if(line.trim()) rows.push(splitLine(line,delim)); }
    return {header,rows,delim};
  }
  function pickIdx(H, names){ names=Array.isArray(names)?names:[names]; for(const n of names){ const i=H.indexOf(norm(n)); if(i!==-1) return i; } return -1; }
  function toNum(s){
    if(s==null) return 0;
    let t=String(s).trim().replace(/[^\d,.\-]/g,'');
    if(t.indexOf(',')>-1 && t.lastIndexOf(',')>t.lastIndexOf('.')){ t=t.replace(/\./g,'').replace(',', '.'); }
    else { t=t.replace(/,/g,''); }
    const n=Number(t); return isFinite(n)?n:0;
  }
  function parseMaybeDate(s){
    if(!s) return '';
    s=String(s).trim();
    const iso=/^\d{4}-\d{2}-\d{2}$/;
    const dmySlash=/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/;
    const dmyDash=/^(\d{1,2})-(\d{1,2})-(\d{2,4})$/;
    const dmyText=/^(\d{1,2})\s+([A-Za-z]{3,9})\s+(\d{2,4})$/;
    const M={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
    const Y=y=>(+y<100?2000+ +y:+y), z=n=>(n<10?'0':'')+n;
    if(iso.test(s)) return s;
    let m;
    if((m=s.match(dmySlash))) return `${Y(m[3])}-${z(+m[2])}-${z(+m[1])}`;
    if((m=s.match(dmyDash)))  return `${Y(m[3])}-${z(+m[2])}-${z(+m[1])}`;
    if((m=s.match(dmyText)))  return `${Y(m[3])}-${z(M[m[2].slice(0,3).toLowerCase()])}-${z(+m[1])}`;
    return s; // fallback raw
  }

  // -------------------- Import core --------------------
  function importCSVText(text){
    const {header:H, rows} = parseCSV(text);
    logStatus('Header: ' + JSON.stringify(H));
    const I = {
      variety:       pickIdx(H, ['description','product','name','item','variety','flower']),
      grade:         pickIdx(H, ['lengthcm','length','size','cm','grade']),
      stemsPerPack:  pickIdx(H, ['stemsperbunch','stemsperpack','stems','qty','quantity']),
      packPrice:     pickIdx(H, ['unitprice','price','bunchprice','packprice']),
      invoiceDate:   pickIdx(H, ['invoicedate','invoice_date','date','deliverydate','docdate','deldate']),
      supplier:      pickIdx(H, ['supplier','vendor','wholesaler','source']),
      packSize:      pickIdx(H, ['packsize','bunchsize','unit','pack'])
    };
    logStatus('Mapped indexes: ' + JSON.stringify(I));

    let invoiceLevelDate = '';
    if (I.invoiceDate === -1) {
      const ask = prompt('Enter invoice date for these rows (e.g. 28/09/2025 or 2025-09-28):','');
      invoiceLevelDate = parseMaybeDate(ask||'');
    }

    const newRows=[];
    for(const line of rows){
      const r={
        id: uid(),
        variety:      I.variety      >=0 ? line[I.variety] : '',
        grade:        I.grade        >=0 ? line[I.grade] : '',
        supplier:     I.supplier     >=0 ? line[I.supplier] : '',
        packSize:     I.packSize     >=0 ? line[I.packSize] : '',
        stemsPerPack: I.stemsPerPack >=0 ? toNum(line[I.stemsPerPack]) : 0,
        packPrice:    I.packPrice    >=0 ? toNum(line[I.packPrice]) : 0,
        invoiceDate:  I.invoiceDate  >=0 ? parseMaybeDate(line[I.invoiceDate]) : invoiceLevelDate,
        notes: ''
      };
      if(!r.variety && !r.packPrice && !r.stemsPerPack) continue;
      newRows.push(r);
    }

    let st;
    try{ st = JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch{ st={}; }
    if(!st || typeof st!=='object') st={};
    if(!Array.isArray(st.rows)) st.rows=[];
    st.rows = st.rows.concat(newRows);
    if(!st.vatRegisteredFrom) st.vatRegisteredFrom='2025-10-01';
    if(typeof st.vatRate!=='number') st.vatRate=20;
    if(typeof st.laborRate!=='number') st.laborRate=18;
    if(!Array.isArray(st.arrangement)) st.arrangement=[];
    st.photo=null;

    localStorage.setItem(LS_KEY, JSON.stringify(st));
    alert(`Imported CSV rows: ${newRows.length}`);
    location.reload();
  }

  // -------------------- DOM refs --------------------
  const costTableBody = document.querySelector('#costTable tbody');
  const importCSVEl   = document.getElementById('importCSV');
  const pasteCSVBtn   = document.getElementById('pasteCSV');
  const exportCSVBtn  = document.getElementById('exportCSV');
  const vatRegisteredFromEl = document.getElementById('vatRegisteredFrom');
  const vatRateEl = document.getElementById('vatRate');
  const laborRateEl = document.getElementById('laborRate');
  const globalFeesEl = document.getElementById('globalFees');
  const feeShareModeEl = document.getElementById('feeShareMode');
  const arrangementList = document.getElementById('arrangementList');
  const addItemBtn = document.getElementById('addItem');
  const sundriesEl = document.getElementById('sundries');
  const wastagePctEl = document.getElementById('wastagePct');
  const laborMinutesEl = document.getElementById('laborMinutes');
  const targetMarginPctEl = document.getElementById('targetMarginPct');
  const breakdownListEl = document.getElementById('breakdownList');
  const marginEl = document.getElementById('margin');
  const retailExEl = document.getElementById('retailEx');
  const retailIncEl = document.getElementById('retailInc');
  const addRowBtn = document.getElementById('addRow');

  // -------------------- Settings binding --------------------
  function bindSettings(){
    if (vatRegisteredFromEl) vatRegisteredFromEl.value = state.vatRegisteredFrom;
    if (vatRateEl) vatRateEl.value = state.vatRate;
    if (laborRateEl) laborRateEl.value = state.laborRate;
    if (globalFeesEl) globalFeesEl.value = state.globalFees;
    if (feeShareModeEl) feeShareModeEl.value = state.feeShareMode;

    if (vatRegisteredFromEl) vatRegisteredFromEl.oninput = ()=>{ state.vatRegisteredFrom = vatRegisteredFromEl.value; save(); renderAll(); };
    if (vatRateEl) vatRateEl.oninput = ()=>{ state.vatRate = Number(vatRateEl.value)||0; save(); renderAll(); };
    if (laborRateEl) laborRateEl.oninput = ()=>{ state.laborRate = Number(laborRateEl.value)||0; save(); renderAll(); };
    if (globalFeesEl) globalFeesEl.oninput = ()=>{ state.globalFees = Number(globalFeesEl.value)||0; save(); renderAll(); };
    if (feeShareModeEl) feeShareModeEl.onchange = ()=>{ state.feeShareMode = feeShareModeEl.value; save(); renderAll(); };
  }

  // -------------------- Costing --------------------
  const isAfterReg = d => String(d||'') >= String(state.vatRegisteredFrom||'');
  function costPerStemExVAT(r){
    const packEx = isAfterReg(r.invoiceDate) ? r.packPrice : (r.packPrice/(1+(state.vatRate||0)/100));
    return packEx / (r.stemsPerPack||1);
  }
  function totalRowValueExVAT(r){ return costPerStemExVAT(r) * (r.stemsPerPack||0); }
  function totalInvoiceValueExVAT(){ return state.rows.reduce((a,r)=>a+totalRowValueExVAT(r),0); }
  function feePerStemExVAT(r){
    if(state.feeShareMode==='none') return 0;
    const total = totalInvoiceValueExVAT(); if(!total) return 0;
    const share = (totalRowValueExVAT(r)/total)*(state.globalFees||0);
    return share/(r.stemsPerPack||1);
  }
  function displayCostPerStemExVAT(r){ return costPerStemExVAT(r)+feePerStemExVAT(r); }

  // -------------------- Renderers --------------------
  function renderCostTable(){
    if (!costTableBody) return;
    costTableBody.innerHTML='';
    state.rows.forEach((r)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${r.variety||''}"></td>
        <td><input value="${r.grade||''}"></td>
        <td><input value="${r.supplier||''}"></td>
        <td><input value="${r.packSize||''}"></td>
        <td><input type="number" value="${r.stemsPerPack||0}"></td>
        <td><input type="number" step="0.01" value="${r.packPrice||0}"></td>
        <td><input type="date" value="${r.invoiceDate||''}"></td>
        <td class="muted">${money(displayCostPerStemExVAT(r))}</td>
        <td><input value="${r.notes||''}"></td>
        <td><button class="btn danger">Del</button></td>`;
      const inputs = tr.querySelectorAll('input');
      const delBtn = tr.querySelector('button');
      const [v,g,s,ps,sp,pp,id, n] = inputs;
      v.oninput = ()=>{ r.variety=v.value; save(); renderAll(); };
      g.oninput = ()=>{ r.grade=g.value; save(); renderAll(); };
      s.oninput = ()=>{ r.supplier=s.value; save(); renderAll(); };
      ps.oninput= ()=>{ r.packSize=ps.value; save(); renderAll(); };
      sp.oninput= ()=>{ r.stemsPerPack=Number(sp.value)||0; save(); renderAll(); };
      pp.oninput= ()=>{ r.packPrice=Number(pp.value)||0; save(); renderAll(); };
      id.oninput= ()=>{ r.invoiceDate=id.value; save(); renderAll(); };
      n.oninput = ()=>{ r.notes=n.value; save(); };
      delBtn.onclick=()=>{ state.rows=state.rows.filter(x=>x!==r); save(); renderAll(); };
      costTableBody.appendChild(tr);
    });
  }

  function renderArrangement(){
    const el=document.getElementById('arrangementList'); if(!el) return;
    el.innerHTML='';
    state.arrangement.forEach((a,i)=>{
      const row=state.rows.find(r=>r.id===a.rowId);
      const div=document.createElement('div'); div.className='item-row';
      const options=state.rows.map(r=>`<option value="${r.id}" ${r.id===a.rowId?'selected':''}>${r.variety} ${r.grade?`(${r.grade})`:''}</option>`).join('');
      div.innerHTML=`<select>${options}</select><input type="number" value="${a.qty||0}"/><div class="readonly">${row?money(displayCostPerStemExVAT(row)):'-'}</div><div class="del"><button class="btn danger">×</button></div>`;
      const [sel,qty,,del]=div.querySelectorAll('select,input,div,button');
      sel.onchange=()=>{a.rowId=sel.value; save(); renderAll();};
      qty.oninput =()=>{a.qty=Number(qty.value)||0; save(); renderAll();};
      del.onclick  =()=>{state.arrangement=state.arrangement.filter((_,j)=>j!==i); save(); renderAll();};
      el.appendChild(div);
    });
  }

  function calcBreakdown(){
    const items=state.arrangement.map(a=>{
      const r=state.rows.find(x=>x.id===a.rowId); if(!r) return null;
      const cps=displayCostPerStemExVAT(r);
      return {label:`${r.variety} ${r.grade||''}`.trim(),qty:a.qty||0,lineEx:cps*(a.qty||0)};
    }).filter(Boolean);
    const stemsEx=items.reduce((s,i)=>s+i.lineEx,0);
    const wastage=stemsEx*((state.wastagePct||0)/100);
    const laborEx=(state.laborRate/60)*(state.laborMinutes||0);
    const sundriesEx=state.sundries||0;
    const totalEx=stemsEx+wastage+sundriesEx+laborEx;
    const margin=totalEx*((state.targetMarginPct||0)/100);
    const retailEx=totalEx+margin;
    const retailInc=retailEx*(1+(state.vatRate||0)/100);
    return {items,stemsEx,wastage,sundriesEx,laborEx,totalEx,margin,retailEx,retailInc};
  }
  function renderBreakdown(){
    const b=calcBreakdown(); const el=breakdownListEl; if(!el) return;
    el.innerHTML='';
    b.items.forEach(i=>{ const row=document.createElement('div'); row.innerHTML=`<span>${i.label} × ${i.qty}</span><strong>${money(i.lineEx)}</strong>`; el.appendChild(row); });
    const add=(k,v)=>{ const row=document.createElement('div'); row.innerHTML=`<span>${k}</span><strong>${money(v)}</strong>`; el.appendChild(row); };
    el.appendChild(document.createElement('hr'));
    add('Stems subtotal',b.stemsEx);
    add('Wastage',b.wastage);
    add('Sundries',b.sundriesEx);
    add('Labour',b.laborEx);
    el.appendChild(document.createElement('hr'));
    add('Total ex-VAT',b.totalEx);
    marginEl.textContent = money(b.margin);
    retailExEl.textContent= money(b.retailEx);
    retailIncEl.textContent= money(b.retailInc);
  }

  // -------------------- Actions --------------------
  if (document.getElementById('addRow'))
    document.getElementById('addRow').onclick=()=>{
      state.rows.push({ id: uid(), variety:'', grade:'', supplier:'', packSize:'', stemsPerPack:0, packPrice:0, invoiceDate:new Date().toISOString().slice(0,10), notes:'' });
      save(); renderAll();
    };

  function toCSV(rows){
    const header=['variety','grade','supplier','packSize','stemsPerPack','packPrice','invoiceDate','notes'];
    const body=rows.map(r=>[r.variety,r.grade||'',r.supplier||'',r.packSize||'',r.stemsPerPack||0,r.packPrice||0,r.invoiceDate||'',r.notes||'']
      .map(v=>String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:String(v)).join(','));
    return [header.join(','),...body].join('\n');
  }
  if (exportCSVBtn) exportCSVBtn.onclick=()=>{
    const csv=toCSV(state.rows);
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='flower_costs.csv'; a.click(); URL.revokeObjectURL(url);
  };

  // File input
  if (importCSVEl){
    importCSVEl.onchange=(e)=>{
      const f=e.target.files?.[0];
      if(!f){ logStatus('No file selected'); return; }
      logStatus('Selected: ' + f.name + ' (' + (f.type||'unknown type') + ')');
      const reader=new FileReader();
      reader.onload=()=>{ logStatus('Read ' + String(reader.result||'').length + ' chars'); importCSVText(String(reader.result||'')); };
      reader.onerror=()=>{ logStatus('FileReader error: ' + reader.error); alert('Read error: ' + reader.error); };
      reader.readAsText(f);
    };
  }

  // Paste CSV button (works even if file input blocked)
  if (pasteCSVBtn){
    pasteCSVBtn.onclick=()=>{
      const raw = prompt('Paste CSV text here:');
      if(!raw){ alert('No text'); return; }
      importCSVText(raw);
    };
  }

  // Drag & drop anywhere
  document.addEventListener('dragover',(e)=>{ e.preventDefault(); });
  document.addEventListener('drop',(e)=>{
    e.preventDefault();
    const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (!f){ logStatus('Drop: no file'); return; }
    logStatus('Dropped: ' + f.name);
    const reader=new FileReader();
    reader.onload=()=>{ importCSVText(String(reader.result||'')); };
    reader.readAsText(f);
  });

  // -------------------- Photo Assist (safe) --------------------
  const photoInput=document.getElementById('photoInput');
  const photoCanvas=document.getElementById('photoCanvas');
  const ctx=photoCanvas?photoCanvas.getContext('2d'):null;
  const photoVarietySelect=document.getElementById('photoVarietySelect');
  const clearBtn=document.getElementById('clearMarkers');

  function renderPhotoVarietyOptions(){
    if (!photoVarietySelect) return;
    photoVarietySelect.innerHTML='<option value="">Select flower...</option>' +
      state.rows.map(r=>`<option value="${r.id}">${r.variety} ${r.grade?`(${r.grade})`:''}</option>`).join('');
  }
  function drawPhoto(){
    if(!photoCanvas || !ctx) return;
    const img=state.photo;
    if(!(img instanceof Image)){
      photoCanvas.width=1000; photoCanvas.height=600;
      ctx.fillStyle='#f3f4f6'; ctx.fillRect(0,0,photoCanvas.width,photoCanvas.height);
      ctx.fillStyle='#64748b'; ctx.fillText('Load a photo to start',20,30);
      return;
    }
    const maxW=photoCanvas.parentElement.clientWidth-2;
    const scale=Math.min(maxW/img.width,1);
    photoCanvas.width=Math.floor(img.width*scale);
    photoCanvas.height=Math.floor(img.height*scale);
    ctx.clearRect(0,0,photoCanvas.width,photoCanvas.height);
    ctx.drawImage(img,0,0,photoCanvas.width,photoCanvas.height);
    for(const m of state.photoMarkers){
      const x=m.x*scale, y=m.y*scale;
      ctx.beginPath(); ctx.arc(x,y,8,0,Math.PI*2);
      ctx.fillStyle='#0EA5E9aa'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#0EA5E9'; ctx.stroke();
    }
  }
  if (photoInput) photoInput.onchange=(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=(evt)=>{
      const img=new Image();
      img.onload=()=>{ state.photo=img; state.photoMarkers=[]; if(clearBtn) clearBtn.disabled=true; drawPhoto(); };
      img.src=evt.target.result;
    };
    reader.readAsDataURL(f);
  };
  if (photoCanvas) photoCanvas.addEventListener('click',(e)=>{
    if(!(state.photo instanceof Image)) return;
    const sel=photoVarietySelect.value;
    if(!sel){ alert('Select a flower first'); return; }
    const rect=photoCanvas.getBoundingClientRect();
    const x=e.clientX-rect.left, y=e.clientY-rect.top;
    const scale=photoCanvas.width/state.photo.width;
    const ix=x/scale, iy=y/scale;
    state.photoMarkers.push({x:ix,y:iy,rowId:sel});
    if(clearBtn) clearBtn.disabled=false;
    const idx=state.arrangement.findIndex(a=>a.rowId===sel);
    if(idx>=0) state.arrangement[idx].qty=(state.arrangement[idx].qty||0)+1;
    else state.arrangement.push({rowId:sel,qty:1});
    save(); drawPhoto(); renderAll();
  });
  if (clearBtn) clearBtn.onclick=()=>{ state.photoMarkers=[]; clearBtn.disabled=true; drawPhoto(); };

  // -------------------- Render all --------------------
  function renderAll(){
    // settings
    bindSettings();
    // list/table
    renderCostTable();
    renderArrangement();
    renderBreakdown();
    renderPhotoVarietyOptions();
    drawPhoto();
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    renderAll();
    logStatus('Diagnostics ready. Use Import, drag a CSV onto the page, or click "Paste CSV".');
  });
  </script>

  <!-- Intentionally NOT registering a service worker to avoid stale caches while fixing -->
</body>
</html>
